`/bin/bash -c 'save_history() {
    if [[ "false" == "true" ]]; then
        echo " ---> $BASH_COMMAND" >&2
    fi
     history -s "$BASH_COMMAND"
    history -a
}

save_env() {
    set +x
    set > /meta/.env
    # Ignore read-only variables
    for l in BASHOPTS BASH_VERSINFO UID EUID PPID SHELLOPTS; do
        grep -v "^$l=" /meta/.env > /meta/.env2
        mv /meta/.env2 /meta/.env
    done
    echo "cd $(pwd)" >> /meta/.env
}

# If /meta is mounted, then we want to save history and environment
if [[ -d /meta ]]; then
    trap save_history DEBUG
    trap save_env INT TERM EXIT ERR
fi

# Stop if we hit any errors.
set -e

cd $WORKSPACE/srcdir/zlib-*

# On windows platforms, our ./configure and make invocations differ a bit
if [[ ${target} == *-w64-mingw* ]]; then
    EXTRA_CONFIGURE_FLAGS="--sharedlibdir=${prefix}/bin"
    EXTRA_MAKE_FLAGS="SHAREDLIB=libz.dll SHAREDLIBM=libz-1.dll SHAREDLIBV=libz-1.2.11.dll LDSHAREDLIBC= "
fi

./configure ${EXTRA_CONFIGURE_FLAGS} --prefix=${prefix}
make install ${EXTRA_MAKE_FLAGS} -j${nproc}

# Materialize DLL files (https://github.com/bicycle1885/CodecZlib.jl/issues/24).
if [[ ${target} == *-w64-mingw* ]]; then
    mkdir ${WORKSPACE}/destdir/tmp
    cp -L ${WORKSPACE}/destdir/bin/* ${WORKSPACE}/destdir/tmp
    rm -r ${WORKSPACE}/destdir/bin
    mv ${WORKSPACE}/destdir/tmp ${WORKSPACE}/destdir/bin
fi

'`
Checking for shared library support...
Building shared library libz.so.1.2.11 with /opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc.
Checking for size_t... Yes.
Checking for off64_t... Yes.
Checking for fseeko... Yes.
Checking for strerror... Yes.
Checking for unistd.h... Yes.
Checking for stdarg.h... Yes.
Checking whether to use vs[n]printf() or s[n]printf()... using vs[n]printf().
Checking for vsnprintf() in stdio.h... Yes.
Checking for return value of vsnprintf()... Yes.
Checking for attribute(visibility) support... Yes.
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o adler32.o adler32.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o crc32.o crc32.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o deflate.o deflate.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o infback.o infback.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o inffast.o inffast.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o inflate.o inflate.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o inftrees.o inftrees.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o trees.o trees.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o zutil.o zutil.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o compress.o compress.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o uncompr.o uncompr.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o gzclose.o gzclose.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o gzlib.o gzlib.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o gzread.o gzread.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -c -o gzwrite.o gzwrite.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/adler32.o adler32.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/crc32.o crc32.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/deflate.o deflate.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/infback.o infback.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/inffast.o inffast.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/inflate.o inflate.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/inftrees.o inftrees.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/trees.o trees.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/zutil.o zutil.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/compress.o compress.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/uncompr.o uncompr.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/gzclose.o gzclose.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/gzlib.o gzlib.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/gzread.o gzread.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN  -DPIC -c -o objs/gzwrite.o gzwrite.c
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-ar rc libz.a adler32.o crc32.o deflate.o infback.o inffast.o inflate.o inftrees.o trees.o zutil.o compress.o uncompr.o gzclose.o gzlib.o gzread.o gzwrite.o 
/opt/x86_64-linux-gnu/bin/x86_64-linux-gnu-gcc -shared -Wl,-soname,libz.so.1,--version-script,zlib.map -O3 -fPIC -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o libz.so.1.2.11 adler32.lo crc32.lo deflate.lo infback.lo inffast.lo inflate.lo inftrees.lo trees.lo zutil.lo compress.lo uncompr.lo gzclose.lo gzlib.lo gzread.lo gzwrite.lo  -lc 
rm -f libz.so libz.so.1
ln -s libz.so.1.2.11 libz.so
ln -s libz.so.1.2.11 libz.so.1
rm -f /workspace/destdir/lib/libz.a
cp libz.a /workspace/destdir/lib
chmod 644 /workspace/destdir/lib/libz.a
cp libz.so.1.2.11 /workspace/destdir/lib
chmod 755 /workspace/destdir/lib/libz.so.1.2.11
rm -f /workspace/destdir/share/man/man3/zlib.3
cp zlib.3 /workspace/destdir/share/man/man3
chmod 644 /workspace/destdir/share/man/man3/zlib.3
rm -f /workspace/destdir/lib/pkgconfig/zlib.pc
cp zlib.pc /workspace/destdir/lib/pkgconfig
chmod 644 /workspace/destdir/lib/pkgconfig/zlib.pc
rm -f /workspace/destdir/include/zlib.h /workspace/destdir/include/zconf.h
cp zlib.h zconf.h /workspace/destdir/include
chmod 644 /workspace/destdir/include/zlib.h /workspace/destdir/include/zconf.h
